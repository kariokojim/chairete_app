{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h4>Loan Disbursement</h4>

  <form method="POST" action="{{ url_for('admin.disburse_loan') }}">
    {{ form.hidden_tag() }}

    <!-- MEMBER INFO -->
    <div class="card p-3 mb-3 shadow-sm">
      <div class="row g-3">
        <div class="col-md-3">
          {{ form.member_no.label(class="form-label") }}
          {{ form.member_no(class="form-control", id="member_no", placeholder="Enter Member No") }}
        </div>
        <div class="col-md-4">
          <label class="form-label">Member Name</label>
          <input type="text" id="member_name" class="form-control" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label">Savings Balance</label>
          <input type="text" id="savings_balance" class="form-control" readonly>
        </div>
      </div>
    </div>

    <!-- LOAN DETAILS -->
    <div class="card p-3 mb-3 shadow-sm">
      <div class="row g-3">
        <div class="col-md-4">
          {{ form.loan_amount.label(class="form-label") }}
          {{ form.loan_amount(class="form-control") }}
        </div>
        <div class="col-md-4">
          {{ form.loan_period.label(class="form-label") }}
          {{ form.loan_period(class="form-control") }}
        </div>
        <div class="col-md-4">
          {{ form.loan_type.label(class="form-label") }}
          {{ form.loan_type(class="form-select") }}
        </div>
      </div>
    </div>

    <!-- GUARANTORS -->
    <div class="card p-3 mb-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6>Guarantors</h6>
        <button type="button" id="addGuarantor" class="btn btn-sm btn-secondary">+ Add Guarantor</button>
      </div>

      <div id="guarantors-section">
        <!-- One default row -->
        <div class="guarantor-row row g-2 mb-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">Member No</label>
            <input type="text" name="guarantors[0][member_no]" class="form-control guarantor-no" placeholder="Member No">
          </div>
          <div class="col-md-4">
            <label class="form-label">Guarantor Name</label>
            <input type="text" class="form-control guarantor-name" readonly>
          </div>
          <div class="col-md-3">
            <label class="form-label">Savings</label>
            <input type="text" class="form-control guarantor-saving" readonly>
          </div>
          <div class="col-md-2">
            <label class="form-label">Amount Guaranteed</label>
            <input type="number" name="guarantors[0][amount_guaranteed]" class="form-control">
          </div>
        </div>
      </div>
    </div>

    <div class="text-end mt-3">
      <button type="submit" class="btn btn-primary">Disburse Loan</button>
    </div>
  </form>
</div>
{% if request.method == 'POST' %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const guarantors = {{ request.form|tojson }};
  for (const key in guarantors) {
    if (key.startsWith("guarantors[")) {
      const input = document.querySelector(`[name="${key}"]`);
      if (input) input.value = guarantors[key];
    }
  }
});
</script>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {

  // --- Member auto lookup
  const memberNoInput = document.getElementById("member_no");
  memberNoInput.addEventListener("blur", async () => {
    const memberNo = memberNoInput.value.trim();
    if (!memberNo) return;
    try {
	  const resp = await fetch(`/admin/api/member_info/${memberNo}`);
      const data = await resp.json();
      if (data.error) {
        alert(data.error);
        document.getElementById("member_name").value = "";
        document.getElementById("savings_balance").value = "";
      } else {
        document.getElementById("member_name").value = data.member_name;
        document.getElementById("savings_balance").value = data.savings_balance.toFixed(2);
      }
    } catch (err) {
      console.error(err);
    }
  });

  // --- Function to bind guarantor auto lookup
  function bindGuarantorLookup(row) {
    const input = row.querySelector(".guarantor-no");
    input.addEventListener("blur", async (e) => {
      const gNo = e.target.value.trim();
      if (!gNo) return;
      try {
        const resp = await fetch(`/admin/api/member_info/${gNo}`);
        const data = await resp.json();
        if (data.error) {
          alert(data.error);
          row.querySelector(".guarantor-name").value = "";
          row.querySelector(".guarantor-saving").value = "";
        } else {
          row.querySelector(".guarantor-name").value = data.member_name;
          row.querySelector(".guarantor-saving").value = data.savings_balance.toFixed(2);
        }
      } catch (err) {
        console.error(err);
      }
    });
  }

  // --- Bind lookup to the first default row
  document.querySelectorAll(".guarantor-row").forEach(row => bindGuarantorLookup(row));

  // --- Add guarantor dynamically
  let guarantorIndex = 1;
  const addBtn = document.getElementById("addGuarantor");
  const section = document.getElementById("guarantors-section");

  addBtn.addEventListener("click", () => {
    const newRow = document.createElement("div");
    newRow.classList.add("guarantor-row", "row", "g-2", "mb-2", "align-items-end");
    newRow.innerHTML = `
      <div class="col-md-3">
        <input type="text" name="guarantors[${guarantorIndex}][member_no]" class="form-control guarantor-no" placeholder="Member No">
      </div>
      <div class="col-md-4">
        <input type="text" class="form-control guarantor-name" placeholder="Guarantor Name" readonly>
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control guarantor-saving" placeholder="Savings Balance" readonly>
      </div>
      <div class="col-md-2">
        <input type="number" name="guarantors[${guarantorIndex}][amount_guaranteed]" class="form-control" placeholder="Amount Guaranteed">
      </div>`;
    section.appendChild(newRow);
    bindGuarantorLookup(newRow);
    guarantorIndex++;
  });

});
</script>
{% endblock %}
