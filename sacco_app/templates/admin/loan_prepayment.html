{% extends "base.html" %}
{% block title %}Loan Prepayment{% endblock %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-lg border-0 rounded-3">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">üí∞ Loan Prepayment (Principal Only)</h5>
    </div>
    <div class="card-body">
      <form id="prepayForm" method="POST" action="{{ url_for('admin.loan_prepayment') }}">
        {{ form.hidden_tag() }}

        <div class="row mb-3">
          <div class="col-md-4">
            {{ form.member_no.label(class="form-label") }}
            {{ form.member_no(class="form-control", id="member_no", placeholder="Enter Member No") }}
            <small id="member_info" class="text-muted d-block mt-1"></small>
          </div>
          <div class="col-md-4">
            {{ form.amount.label(class="form-label") }}
            {{ form.amount(class="form-control", id="amount", placeholder="Enter Prepayment Amount") }}
          </div>
          <div class="col-md-4">
            {{ form.bank_txn_date.label(class="form-label") }}
            {{ form.bank_txn_date(class="form-control", id="bank_txn_date") }}
          </div>
        </div>

        <div class="mb-3">
          {{ form.narration.label(class="form-label") }}
          {{ form.narration(class="form-control", id="narration", placeholder="Enter Narration (Optional)") }}
        </div>

        <div class="text-end">
          <button type="button" id="openConfirm" class="btn btn-success px-4">Review & Confirm</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Loan Prepayment</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <dl class="row mb-0">
          <dt class="col-5">Member</dt>
          <dd class="col-7" id="c_member_name">‚Äî</dd>

          <dt class="col-5">Member No</dt>
          <dd class="col-7" id="c_member_no">‚Äî</dd>

          <dt class="col-5">Loan No</dt>
          <dd class="col-7" id="c_loan_no">‚Äî</dd>

          <dt class="col-5">Current Balance</dt>
          <dd class="col-7" id="c_balance">‚Äî</dd>

          <dt class="col-5">Prepay Amount</dt>
          <dd class="col-7" id="c_amount">‚Äî</dd>

          <dt class="col-5">Txn Date</dt>
          <dd class="col-7" id="c_date">‚Äî</dd>

          <dt class="col-5">Narration</dt>
          <dd class="col-7" id="c_narration">‚Äî</dd>
        </dl>
        <hr class="my-2">
        <p class="small text-muted mb-0">
          This prepayment will be posted <strong>directly to principal</strong>. No interest will be charged on this prepaid portion. Schedules are not adjusted automatically.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" id="confirmSubmit" class="btn btn-primary">Confirm & Post</button>
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const memberInput = document.getElementById("member_no");
  const infoDisplay = document.getElementById("member_info");
  const openBtn = document.getElementById("openConfirm");
  const form = document.getElementById("prepayForm");
  let cachedLookup = null; // store last member lookup for modal

  function fmt(n) {
    const x = Number(n);
    if (isNaN(x)) return n;
    return x.toLocaleString();
  }

  async function fetchMemberLoan(memberNo) {
    if (!memberNo) return null;
    infoDisplay.innerHTML = "‚è≥ Checking member info...";
    try {
      const resp = await fetch(`/admin/api/member_loan_info/${memberNo}`);
      const data = await resp.json();
      if (!resp.ok || data.error) {
        infoDisplay.innerHTML = `<span class="text-danger">‚ùå Member not found or no active loan.</span>`;
        return null;
      }
      let html = `<strong>${data.member_name}</strong><br>`;
      if (data.loan_no) {
        html += `Loan No: <strong>${data.loan_no}</strong><br>`;
        html += `Current Balance: <strong>${fmt(data.loan_balance)}</strong>`;
      } else {
        html += `<span class="text-warning">No active loan found</span>`;
      }
      infoDisplay.innerHTML = html;
      return data;
    } catch (err) {
      console.error(err);
      infoDisplay.innerHTML = `<span class="text-danger">‚ö†Ô∏è Error loading member info.</span>`;
      return null;
    }
  }

  memberInput.addEventListener("blur", async () => {
    const data = await fetchMemberLoan(memberInput.value.trim());
    cachedLookup = data;
  });

  // Open Confirm modal
  openBtn.addEventListener("click", async () => {
    const memberNo = memberInput.value.trim();
    const amount = document.getElementById("amount").value;
    const date = document.getElementById("bank_txn_date").value;
    const narration = document.getElementById("narration").value;

    // basic client validation
    if (!memberNo) { alert("Enter Member No"); return; }
    if (!amount || Number(amount) <= 0) { alert("Enter a valid prepayment amount"); return; }
    if (!date) { alert("Enter transaction date"); return; }

    // ensure we have latest lookup (or fetch)
    if (!cachedLookup || cachedLookup.member_no !== memberNo) {
      cachedLookup = await fetchMemberLoan(memberNo);
    }
    if (!cachedLookup) { alert("Member not found or no active loan."); return; }

    // fill modal
    document.getElementById("c_member_name").textContent = cachedLookup.member_name || "‚Äî";
    document.getElementById("c_member_no").textContent = cachedLookup.member_no || "‚Äî";
    document.getElementById("c_loan_no").textContent = cachedLookup.loan_no || "‚Äî";
    document.getElementById("c_balance").textContent = fmt(cachedLookup.loan_balance || 0);
    document.getElementById("c_amount").textContent = fmt(amount);
    document.getElementById("c_date").textContent = date || "‚Äî";
    document.getElementById("c_narration").textContent = narration || "‚Äî";

    // show modal
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();

    // one-time handler for confirm
    const confirmBtn = document.getElementById("confirmSubmit");
    const handler = () => {
      confirmBtn.removeEventListener("click", handler);
      form.submit();
    };
    confirmBtn.addEventListener("click", handler);
  });
});
</script>
{% endblock %}
